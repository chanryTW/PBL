var verson="1.0.0";
angular.module("app.controllers",["ngImgCrop"]).controller("loginCtrl",["$scope","$stateParams","$ionicPopup","$state","$ionicLoading",function(a,q,k,l,m){a.loginSmtBtn=function(){m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u767b\u5165\u4e2d...</p>'});firebase.auth().signInWithEmailAndPassword(accountL.value+"@nkust.edu.tw",pwdL.value).then(function(){console.log("\u767b\u5165\u6210\u529f");var a=accountL.value.toUpperCase();accountL.value="";pwdL.value="";m.hide();
"ROOT"==a?l.go("rootmenu.root_pbl",{StuID:a}):l.go("choose_class",{StuID:a})})["catch"](function(a){var h=a.code;console.log("\u767b\u5165\u5931\u6557\uff1a",a.message);m.hide();switch(h){case "auth/user-not-found":a=k.alert({title:"\u767b\u5165\u5931\u6557",template:"\u67e5\u7121\u6b64\u5e33\u865f\u3002"});a.then(function(a){accountL.value="";pwdL.value=""});break;case "auth/invalid-email":a=k.alert({title:"\u767b\u5165\u5931\u6557",template:"\u683c\u5f0f\u6709\u8aa4\u3002"});a.then(function(a){accountL.value=
""});break;case "auth/wrong-password":a=k.alert({title:"\u767b\u5165\u5931\u6557",template:"\u5bc6\u78bc\u932f\u8aa4\u3002"}),a.then(function(a){pwdL.value=""})}})};a.forgetBtn=function(){a.data={};k.show({title:"\u5fd8\u8a18\u5bc6\u78bc",subTitle:"\u8acb\u8f38\u5165\u5b78\u865f\uff0c\u91cd\u8a2d\u4fe1\u4ef6\u5c07\u5bc4\u9001\u81f3nkust\u4fe1\u7bb1",template:'<input type="text" ng-model="data.forgetInput" placeholder="ex:C107193000">',scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},
{text:"\u9001\u51fa",type:"button-chanry1",onTap:function(g){console.log("\u9078\u64c7\u9001\u51fa");firebase.auth().sendPasswordResetEmail(a.data.forgetInput+"@nkust.edu.tw").then(function(){console.log("\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u6210\u529f");k.alert({title:"\u6210\u529f",template:"\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u6210\u529f\uff0c\u8acb\u81f3 "+a.data.forgetInput+"@nkust.edu.tw \u6536\u4fe1"})})["catch"](function(a){console.log("\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u5931\u6557");
switch(a.code){case "auth/user-not-found":k.alert({title:"\u5bc4\u4fe1\u5931\u6557",template:"\u67e5\u7121\u6b64\u5e33\u865f\u3002"})}})}}]})}}]).controller("choose_classCtrl",["$scope","$stateParams","$state","$ionicLoading","$timeout",function(a,q,k,l,m){l.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u8f09\u5165\u8ab2\u7a0b\u4e2d...</p>'});var g=[];firebase.firestore().collection("\u8ab2\u7a0b").where("ClassStu","array-contains",q.StuID).get().then(function(h){h.forEach(function(h){g.push(h.data());
a.items=g;a.$apply()})});l.hide();a.choose_class=function(a,g){localStorage.setItem("ClassID",a);localStorage.setItem("ClassName",g);k.go("menu.pbl")}}]).controller("chatroomCtrl",["$scope","$stateParams","$state","$ionicLoading","$ionicScrollDelegate",function(a,q,k,l,m){var g=firebase.firestore();firebase.auth().onAuthStateChanged(function(h){if(h){console.log("\u5df2\u767b\u5165\u72c0\u614b");var f=h.email.substring(0,h.email.indexOf("@")).toUpperCase(),c=localStorage.getItem("ClassID"),e=localStorage.getItem("StuName");
a.messages=[];g.collection("\u7559\u8a00\u7248").doc(c).collection("messages").orderBy("time","asc").onSnapshot(function(b){b.docChanges().forEach(function(b){"added"===b.type&&g.collection("\u5e33\u865f").doc(b.doc.data().StuID).get().then(function(n){firebase.storage().ref().child("members/"+n.data().Img).getDownloadURL().then(function(d){a.messages.push({messageName:b.doc.data().StuID+" "+b.doc.data().StuName,messageImg:d,messageContent:b.doc.data().content,time:b.doc.data().time});a.$apply();
m.scrollBottom();m.resize()})})["catch"](function(a){console.log("\u67e5\u8a62\u5716\u7247\u6a94\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});"modified"===b.type&&console.log("\u4fee\u6539: ",b.doc.data());"removed"===b.type&&console.log("\u522a\u9664: ",b.doc.data())})});a.addMessage=function(){l.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u65b0\u589e\u4e2d...</p>'});void 0!=a.inputMessage&&""!=a.inputMessage&&(g.collection("\u7559\u8a00\u7248").doc(c).collection("messages").add({StuID:f,
StuName:e,content:a.inputMessage,time:new Date}).then(function(a){console.log("\u65b0\u589e\u7559\u8a00\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589e\u7559\u8a00\u5931\u6557\uff1a",a)}),a.inputMessage="");l.hide()}}else console.log("\u5c1a\u672a\u767b\u5165"),k.go("login")})}]).controller("pblCtrl",["$scope","$stateParams","$state","$ionicPopup","$ionicLoading",function(a,q,k,l,m){var g=firebase.firestore();firebase.auth().onAuthStateChanged(function(h){if(h){console.log("\u5df2\u767b\u5165\u72c0\u614b");
var f=h.email.substring(0,h.email.indexOf("@")).toUpperCase(),c=localStorage.getItem("ClassID");console.log(f);g.collection("\u8ab2\u7a0b").doc(c).onSnapshot(function(b){a.items=[{ClassName:b.data().ClassName,ClassContent:b.data().ClassContent}];k.go(k.current,{},{reload:!0})},function(a){console.error("\u8b80\u53d6\u8ab2\u7a0b\u767c\u751f\u932f\u8aa4\uff1a",a);k.go("login")});g.collection("\u8ab2\u7a0b").doc(c).onSnapshot(function(b){a.LockGroupShow=b.data().inviteLock;k.go(k.current,{},{reload:!0});
console.log("\u662f\u5426\u958b\u653e\u5206\u7d44\uff1a",a.LockGroupShow)},function(a){console.error("\u641c\u5c0b\u662f\u5426\u958b\u653e\u5206\u7d44\u767c\u751f\u932f\u8aa4\uff1a",a)});var e="";g.collection("\u5206\u7d44").doc(c).collection("student").doc(f).onSnapshot(function(b){!1===b.data().grouped?(console.log("\u6c92\u6709\u5c0f\u7d44",b.data()),a.leaderGroupShow=!1,a.addGroupShow=!0,a.quitGroupShow=!1,a.members=[],localStorage.setItem("GroupID","none"),k.go(k.current,{},{reload:!0})):!0===
b.data().grouped&&(console.log("\u6709\u5c0f\u7d44",b.data()),a.addGroupShow=!1,g.collection("\u5206\u7d44").doc(c).collection("group").where("leader","==",f).get().then(function(b){b.empty?(console.log("\u4f60\u975e\u7d44\u9577"),a.quitGroupShow=!0):(console.log("\u4f60\u662f\u7d44\u9577"),b.forEach(function(a){e=a.id}),a.leaderGroupShow=!0,k.go(k.current,{},{reload:!0}))})["catch"](function(a){console.log("\u53d6\u5f97\u672a\u5206\u7d44\u540d\u55ae\u767c\u751f\u932f\u8aa4\uff1a",a)}))},function(a){console.log("\u641c\u5c0b\u662f\u5426\u5df2\u6709\u5c0f\u7d44\u767c\u751f\u932f\u8aa4\uff1a",
a)});g.collection("\u5206\u7d44").doc(c).collection("group").where("members","array-contains",f).onSnapshot(function(b){b.forEach(function(b){localStorage.setItem("GroupID",b.id);a.members=[];console.log("\u5c0f\u7d44\u72c0\u614b",b.data().members);for(var n={$jscomp$loop$prop$index$4:0};n.$jscomp$loop$prop$index$4<b.data().members.length;n={$jscomp$loop$prop$index$4:n.$jscomp$loop$prop$index$4},n.$jscomp$loop$prop$index$4++)g.collection("\u5e33\u865f").doc(b.data().members[n.$jscomp$loop$prop$index$4]).get().then(function(d){return function(n){var e=
!1;0==d.$jscomp$loop$prop$index$4&&(e=!0);firebase.storage().ref().child("members/"+n.data().Img).getDownloadURL().then(function(p){a.members.push({memberID:b.data().members[d.$jscomp$loop$prop$index$4],memberName:n.data().Name,memberImg:p,leader:e});k.go(k.current,{},{reload:!0});console.log(a.members)})}}(n))["catch"](function(a){console.log("\u67e5\u8a62\u5e33\u865f\u8cc7\u6599\u767c\u751f\u932f\u8aa4\uff1a",a)})})},function(a){console.log("\u6aa2\u67e5\u5c0f\u7d44\u72c0\u614b\u767c\u751f\u932f\u8aa4\uff1a",
a)});a.addGroup=function(b){a.Stus=[];m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u8f09\u5165\u5b78\u751f\u4e2d...</p>'});g.collection("\u5206\u7d44").doc(c).collection("student").where("grouped","==",!1).get().then(function(b){b.empty?console.log("\u5168\u73ed\u90fd\u5df2\u5206\u7d44"):b.forEach(function(n){if(n.id!=f){var d=b.docs[b.docs.length-1].id;g.collection("\u5e33\u865f").doc(n.id).get().then(function(b){a.Stus.push({StuID:n.id,Name:b.data().Name,Checked:!1});
k.go(k.current,{},{reload:!0});n.id==d&&m.hide()})["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)})}});console.log("\u53d6\u5f97\u672a\u5206\u7d44\u540d\u55ae\uff1a",a.Stus);k.go(k.current,{},{reload:!0})})["catch"](function(a){console.log("\u53d6\u5f97\u672a\u5206\u7d44\u540d\u55ae\u767c\u751f\u932f\u8aa4\uff1a",a)});a.checkStus=[];g.collection("\u8ab2\u7a0b").doc(c).get().then(function(b){var n=0;n=0==a.members.length?1:a.members.length;a.maxMember=
{now:n+a.checkStus.length,maxMember:b.data().maxMembers};a.check=function(d){-1===a.checkStus.indexOf(d)?a.checkStus.push(d):a.checkStus.splice(a.checkStus.indexOf(d),1);n+a.checkStus.length>b.data().maxMembers&&(console.log("\u8d85\u904e\u4e0a\u9650"),a.checkStus.splice(a.checkStus.indexOf(d),1),d=$.map(a.Stus,function(a,b){return a.StuID}).indexOf(d),a.Stus[d].Checked=!1);a.maxMember={now:n+a.checkStus.length,maxMember:b.data().maxMembers};console.log(a.checkStus)}})["catch"](function(a){console.log("\u67e5\u8a62\u7d44\u54e1\u4e0a\u9650\u767c\u751f\u932f\u8aa4\uff1a",
a)});"invite"==b?l.show({title:"\u9078\u64c7\u7d44\u54e1",subTitle:"\u9080\u8acb\u5f8c\u9700\u7b49\u5f85\u5c0d\u65b9\u540c\u610f\u52a0\u5165\u624d\u6703\u52a0\u5165\u3002",template:'<div ng-model="maxMember">\u7d44\u54e1\u4eba\u6578\u9650\u5236\uff1a{{maxMember.now}}/{{maxMember.maxMember}}</div><div ng-repeat="Stu in Stus"><ion-checkbox ng-model="Stu.Checked" ng-click="check(Stu.StuID)">{{Stu.StuID}} {{Stu.Name}}</ion-checkbox></div>',scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},
{text:"\u9080\u8acb",type:"button-chanry1",onTap:function(b){console.log("\u9078\u64c7\u9080\u8acb");0==a.checkStus.length?(console.log("\u8acb\u52fe\u9078\u6210\u54e1"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u9078\u64c7\u81f3\u5c11\u4e00\u540d\u6210\u54e1\u3002"})):g.collection("\u5206\u7d44").doc(c).collection("group").doc(e).update({inviting:a.checkStus}).then(function(){console.log("\u66f4\u65b0\u5c0f\u7d44\u9080\u8acb\u540d\u55ae\u6210\u529f");for(var b=0;b<a.checkStus.length;b++)g.collection("\u5206\u7d44").doc(c).collection("student").doc(a.checkStus[b]).collection("invite").add({leader:f,
groupID:e,respond:!1}).then(function(){console.log("\u50b3\u9001\u9080\u8acb\u901a\u77e5\u6210\u529f")})["catch"](function(a){console.error("\u50b3\u9001\u9080\u8acb\u901a\u77e5\u5931\u6557\uff1a",a)})})["catch"](function(a){console.error("\u66f4\u65b0\u5c0f\u7d44\u9080\u8acb\u540d\u55ae\u5931\u6557\uff1a",a)})}}]}):l.show({title:"\u9078\u64c7\u7d44\u54e1",subTitle:"\u5275\u7acb\u5f8c\u9700\u7b49\u5f85\u5c0d\u65b9\u540c\u610f\u52a0\u5165\u624d\u6703\u52a0\u5165\u3002",template:'<div ng-model="maxMember">\u7d44\u54e1\u4eba\u6578\u9650\u5236\uff1a{{maxMember.now}}/{{maxMember.maxMember}}</div><div ng-repeat="Stu in Stus"><ion-checkbox ng-model="Stu.Checked" ng-click="check(Stu.StuID)">{{Stu.StuID}} {{Stu.Name}}</ion-checkbox></div>',
scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u5275\u7acb",type:"button-chanry1",onTap:function(b){console.log("\u9078\u64c7\u5275\u7acb");0==a.checkStus.length?(console.log("\u8acb\u52fe\u9078\u6210\u54e1"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u9078\u64c7\u81f3\u5c11\u4e00\u540d\u6210\u54e1\u3002"})):g.collection("\u5206\u7d44").doc(c).collection("group").add({leader:f,members:[f],inviting:a.checkStus}).then(function(b){var d=
b.id;console.log("\u65b0\u589e\u5c0f\u7d44\u6210\u529f");g.collection("\u5206\u7d44").doc(c).collection("student").doc(f).update({grouped:!0}).then(function(b){console.log("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u6210\u529f");for(b=0;b<a.checkStus.length;b++)g.collection("\u5206\u7d44").doc(c).collection("student").doc(a.checkStus[b]).collection("invite").add({leader:f,groupID:d,respond:!1}).then(function(a){console.log("\u50b3\u9001\u9080\u8acb\u901a\u77e5\u6210\u529f")})["catch"](function(a){console.error("\u50b3\u9001\u9080\u8acb\u901a\u77e5\u5931\u6557\uff1a",
a)})})["catch"](function(a){console.error("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u5931\u6557\uff1a",a)})})["catch"](function(a){console.error("\u65b0\u589e\u5c0f\u7d44\u5931\u6557\uff1a",a)})}}]})};a.delGroup=function(b){"del"==b?l.confirm({title:"\u89e3\u6563\u5c0f\u7d44",template:"\u78ba\u5b9a\u8981\u89e3\u6563\u5c0f\u7d44\u55ce?",subTitle:"\u6ce8\u610f\uff1a\u89e3\u6563\u5f8c\u6703\u522a\u9664\u6240\u6709\u5c0f\u7d44\u8cc7\u6599\uff0c\u5305\u62ec\u8a0e\u8ad6\u7d00\u9304\u3001\u4e0a\u50b3\u4f5c\u696d\u3001\u5206\u7d44\u8a55\u5206...\u7b49\u3002",
buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u89e3\u6563",type:"button-chanry1",onTap:function(b){console.log("\u9078\u64c7\u89e3\u6563");g.collection("\u5206\u7d44").doc(c).collection("group").where("leader","==",f).get().then(function(b){b.empty?console.log("\u89e3\u6563\u5c0f\u7d44\u932f\u8aa4\uff1a\u975e\u7d44\u9577"):b.forEach(function(b){for(var d={$jscomp$loop$prop$index$6:0};d.$jscomp$loop$prop$index$6<b.data().inviting.length;d=
{$jscomp$loop$prop$index$6:d.$jscomp$loop$prop$index$6},d.$jscomp$loop$prop$index$6++)g.collection("\u5206\u7d44").doc(c).collection("student").doc(b.data().inviting[d.$jscomp$loop$prop$index$6]).collection("invite").where("groupID","==",b.id).get().then(function(a){return function(d){d.empty?console.log("\u6536\u56de\u9080\u8acb\u901a\u77e5\u932f\u8aa4\uff1a\u7121\u9808\u6536\u56de\u4e4b\u901a\u77e5"):d.forEach(function(d){g.collection("\u5206\u7d44").doc(c).collection("student").doc(b.data().inviting[a.$jscomp$loop$prop$index$6]).collection("invite").doc(d.id).update({respond:!0}).then(function(a){console.log("\u6536\u56de\u9080\u8acb\u901a\u77e5\u6210\u529f")})["catch"](function(a){console.error("\u6536\u56de\u9080\u8acb\u901a\u77e5\u5931\u6557\uff1a",
a)})})}}(d))["catch"](function(a){console.log("\u6536\u56de\u9080\u8acb\u901a\u77e5\u932f\u8aa4\uff1a",a)});for(d=0;d<b.data().members.length;d++)g.collection("\u5206\u7d44").doc(c).collection("student").doc(b.data().members[d]).update({grouped:!1}).then(function(a){console.log("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u5931\u6557\uff1a",a)});g.collection("\u5206\u7d44").doc(c).collection("group").doc(b.id)["delete"]().then(function(b){console.log("\u89e3\u6563\u5c0f\u7d44\u6210\u529f");
a.members=[];k.go(k.current,{},{reload:!0})})["catch"](function(a){console.error("\u89e3\u6563\u5c0f\u7d44\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.log("\u89e3\u6563\u5c0f\u7d44\u932f\u8aa4\uff1a",a)})}}]}):"quit"==b&&l.confirm({title:"\u9000\u51fa\u5c0f\u7d44",template:"\u78ba\u5b9a\u8981\u9000\u51fa\u5c0f\u7d44\u55ce?",buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u9000\u51fa",type:"button-chanry1",onTap:function(a){console.log("\u9078\u64c7\u89e3\u6563");
g.collection("\u5206\u7d44").doc(c).collection("group").where("members","array-contains",f).get().then(function(a){a.forEach(function(a){var b=a.id;a=a.data().members;a.splice(a.indexOf(f),1);g.collection("\u5206\u7d44").doc(c).collection("group").doc(b).update({members:a}).then(function(a){console.log("\u66f4\u65b0members\u8cc7\u6599\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0members\u8cc7\u6599\u5931\u6557\uff1a",a)})})});g.collection("\u5206\u7d44").doc(c).collection("student").doc(f).update({grouped:!1}).then(function(a){console.log("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u5931\u6557\uff1a",
a)})}}]})}}else console.log("\u5c1a\u672a\u767b\u5165"),k.go("login")})}]).controller("voteCtrl",["$scope","$stateParams","$ionicPopup",function(a,q,k){var l=firebase.firestore();firebase.auth().onAuthStateChanged(function(m){if(m){console.log("\u5df2\u767b\u5165\u72c0\u614b");var g=m.email.substring(0,m.email.indexOf("@")).toUpperCase(),h=localStorage.getItem("ClassID"),f=localStorage.getItem("GroupID"),c=localStorage.getItem("StuName");a.votes=[];l.collection("\u6295\u7968").doc(h).collection(f).onSnapshot(function(e){e.empty?
(console.log("\u76ee\u524d\u7121\u6295\u7968"),a.votes=[]):e.docChanges().forEach(function(b){if("added"===b.type){var e=!1,n=!1;-1!=b.doc.data().voteN.indexOf(g)?e=!0:-1!=b.doc.data().voteY.indexOf(g)&&(n=!0);var d=0==b.doc.data().solve?"\u6295\u7968\u4e2d":"\u5df2\u7d50\u6848";l.collection("\u5e33\u865f").doc(b.doc.data().StuID).get().then(function(c){firebase.storage().ref().child("members/"+c.data().Img).getDownloadURL().then(function(c){a.votes.push({voteID:b.doc.id,voteName:b.doc.data().StuID+
" "+b.doc.data().StuName,voteImg:c,title:b.doc.data().title,type:d,content:b.doc.data().content,voteN:b.doc.data().voteN,voteY:b.doc.data().voteY,voteChooseN:e,voteChooseY:n,time:b.doc.data().time});a.$apply();console.log("\u65b0\u589e\uff1a",a.votes)})})["catch"](function(a){console.log("\u67e5\u8a62\u5716\u7247\u6a94\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)})}if("modified"===b.type){n=e=!1;-1!=b.doc.data().voteN.indexOf(g)?e=!0:-1!=b.doc.data().voteY.indexOf(g)&&(n=!0);var c=a.votes.findIndex(function(a){return a.voteID===
b.doc.id});a.votes[c].voteN=b.doc.data().voteN;a.votes[c].voteY=b.doc.data().voteY;a.votes[c].voteChooseN=e;a.votes[c].voteChooseY=n;d=0==b.doc.data().solve?"\u6295\u7968\u4e2d":"\u5df2\u7d50\u6848";a.votes[c].type=d;a.$apply();console.log("\u4fee\u6539\uff1a",b.doc.data())}"removed"===b.type&&(c=a.votes.findIndex(function(a){return a.time.seconds===b.doc.data().time.seconds&a.time.nanoseconds===b.doc.data().time.nanoseconds}),-1!=c?(a.votes.splice(c,1),console.log("\u522a\u9664\u5217\u8868\u6210\u529f")):
console.log("\u522a\u9664\u5217\u8868\u4e0d\u6210\u529f"),a.$apply(),console.log("\u522a\u9664\uff1a",b.doc.data()))})},function(a){console.log("\u53d6\u5f97\u63d0\u8b70\u767c\u751f\u932f\u8aa4\uff1a",a)});a.votebtn=function(e,b){var c=a.votes.findIndex(function(a){return a.voteID===b});-1!=c?("N"==e?-1!=a.votes[c].voteN.indexOf(g)?(a.votes[c].voteN.splice(a.votes[c].voteN.indexOf(g),1),a.votes[c].voteChooseN=!1):(a.votes[c].voteN.push(g),a.votes[c].voteChooseN=!0,-1!=a.votes[c].voteY.indexOf(g)&&
(a.votes[c].voteY.splice(a.votes[c].voteY.indexOf(g),1),a.votes[c].voteChooseY=!1)):"Y"==e&&(-1!=a.votes[c].voteY.indexOf(g)?(a.votes[c].voteY.splice(a.votes[c].voteY.indexOf(g),1),a.votes[c].voteChooseY=!1):(a.votes[c].voteY.push(g),a.votes[c].voteChooseY=!0,-1!=a.votes[c].voteN.indexOf(g)&&(a.votes[c].voteN.splice(a.votes[c].voteN.indexOf(g),1),a.votes[c].voteChooseN=!1))),l.collection("\u5206\u7d44").doc(h).collection("group").doc(f).get().then(function(e){e=e.data().members.length;if(a.votes[c].voteN.length>
e/2||a.votes[c].voteY.length>e/2||a.votes[c].voteN.length==a.votes[c].voteY.length&&a.votes[c].voteY.length==e/2)console.log("\u95dc\u9589\u6295\u7968"),l.collection("\u6295\u7968").doc(h).collection(f).doc(b).update({solve:!0}).then(function(b){console.log("\u95dc\u9589\u6295\u7968\u6210\u529f");a.$apply()})["catch"](function(a){console.error("\u95dc\u9589\u6295\u7968\u5931\u6557\uff1a",a)})})["catch"](function(a){console.log("\u53d6\u5f97\u7d44\u54e1\u4eba\u6578\u767c\u751f\u932f\u8aa4\uff1a",a)}),
l.collection("\u6295\u7968").doc(h).collection(f).doc(b).update({voteN:a.votes[c].voteN,voteY:a.votes[c].voteY}).then(function(a){console.log("\u66f4\u65b0\u4f3a\u670d\u5668\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u4f3a\u670d\u5668\u5931\u6557\uff1a",a)})):console.log("\u53d6\u5f97\u8a72vote\u5931\u6557")};a.Addvote=function(){a.voteInput=[];k.show({title:"\u767c\u8d77\u6295\u7968",template:'<input type="text" ng-model="voteInput.title" placeholder="\u8f38\u5165\u6295\u7968\u6a19\u984c\uff08\u965015\u5b57\u5167\uff09..." maxlength="15" style="margin-bottom:10px; padding:8px;"><textarea cols="50" rows="5" ng-model="voteInput.content" placeholder="\u8f38\u5165\u6295\u7968\u8aaa\u660e\uff08\u965050\u5b57\u5167\uff09..." maxlength="50" style="margin-bottom:10px; padding:8px;"></textarea>',
scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u767c\u8d77",type:"button-chanry1",onTap:function(e){console.log("\u9078\u64c7\u767c\u8d77");""==a.voteInput.title||void 0==a.voteInput.title?(console.log("\u8acb\u586b\u5beb\u6295\u7968\u6a19\u984c"),k.alert({title:"\u932f\u8aa4",template:"\u8acb\u586b\u5beb\u6295\u7968\u6a19\u984c\u3002"})):""==a.voteInput.content||void 0==a.voteInput.content?(console.log("\u8acb\u586b\u5beb\u6295\u7968\u8aaa\u660e"),
k.alert({title:"\u932f\u8aa4",template:"\u8acb\u586b\u5beb\u6295\u7968\u8aaa\u660e\u3002"})):l.collection("\u6295\u7968").doc(h).collection(f).add({StuID:g,StuName:c,title:a.voteInput.title,content:a.voteInput.content,solve:!1,voteN:[],voteY:[g],time:new Date}).then(function(a){console.log("\u65b0\u589e\u6295\u7968\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589e\u6295\u7968\u5931\u6557\uff1a",a)})}}]})}}else console.log("\u5c1a\u672a\u767b\u5165"),$state.go("login")})}]).controller("missionCtrl",
["$scope","$stateParams","$sce","$state",function(a,q,k,l){var m=firebase.firestore();firebase.auth().onAuthStateChanged(function(g){if(g){console.log("\u5df2\u767b\u5165\u72c0\u614b");var h=g.email.substring(0,g.email.indexOf("@")).toUpperCase(),f=localStorage.getItem("ClassID");a.missions=[];m.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(f).collection("\u4efb\u52d9\u5217\u8868").onSnapshot(function(c){c.docChanges().forEach(function(c){if("added"===c.type){console.log("\u65b0\u589e: ",c.doc.data());
var b=0;1==c.doc.data().lock?b=3:-1!=c.doc.data().finished.indexOf(h)?b=1:c.doc.data().TimeOut.toDate()<new Date&&(b=2);var e=Number(c.doc.data().TimeOut.toDate().getMonth())+1,n=c.doc.data().TimeOut.toDate().getDate();9>=c.doc.data().TimeOut.toDate().getDate()&&(n="0"+c.doc.data().TimeOut.toDate().getDate());a.missions.push({missionID:c.doc.id,Name:c.doc.data().Name,Content:c.doc.data().Content,TimeOut:c.doc.data().TimeOut.toDate().getUTCFullYear()+"/"+e+"/"+n,LeaderOnly:c.doc.data().LeaderOnly,
type:c.doc.data().type,Point:c.doc.data().Point,finished:c.doc.data().finished,HTML:k.trustAsHtml(c.doc.data().HTML),time:c.doc.data().time,lock:b,show:!1,isIRS:c.doc.data().isIRS,showMsg:"\u67e5\u770b\u66f4\u591a"});a.$apply()}else"modified"===c.type?(console.log("\u4fee\u6539: ",c.doc.data()),e=a.missions.findIndex(function(a){return a.time.seconds===c.doc.data().time.seconds&a.time.nanoseconds===c.doc.data().time.nanoseconds}),-1!=e?(b=0,1==c.doc.data().lock?b=3:-1!=c.doc.data().finished.indexOf(h)?
b=1:c.doc.data().TimeOut.toDate()<new Date&&(b=2),a.missions[e].lock=b,console.log("\u4fee\u6539\u4efb\u52d9\u6210\u529f")):console.log("\u4fee\u6539\u4efb\u52d9\u4e0d\u6210\u529f"),a.$apply()):"removed"===c.type&&(console.log("\u522a\u9664: ",c.doc.data()),e=a.missions.findIndex(function(a){return a.time.seconds===c.doc.data().time.seconds&a.time.nanoseconds===c.doc.data().time.nanoseconds}),-1!=e?(a.missions.splice(e,1),console.log("\u522a\u9664\u4efb\u52d9\u6210\u529f")):console.log("\u522a\u9664\u4efb\u52d9\u4e0d\u6210\u529f"),
a.$apply())})});a.GoIRS=function(a,e,b){l.go("menu.irs",{TestID:a,TestName:e,TestContent:b})};a.missionShow=function(c){var e=a.missions.findIndex(function(a){return a.$$hashKey===c.$$hashKey});-1!=e?(a.missions[e].show?(a.missions[e].show=!1,a.missions[e].showMsg="\u67e5\u770b\u66f4\u591a"):(a.missions[e].show=!0,a.missions[e].showMsg="\u6536\u5408\u5167\u5bb9"),console.log("\u4fee\u6539\u986f\u793a\u6210\u529f")):console.log("\u4fee\u6539\u986f\u793a\u4e0d\u6210\u529f")};a.response=[];a.responseBtn=
function(c){m.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(f).collection("\u4efb\u52d9\u5217\u8868").doc(c).collection("\u586b\u7b54\u7d50\u679c").add({StuID:h,missionID:c,response:a.response,time:new Date}).then(function(a){console.log("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u6210\u529f")})["catch"](function(a){console.error("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u5931\u6557\uff1a",a)})}}else console.log("\u5c1a\u672a\u767b\u5165"),l.go("login")})}]).controller("irsCtrl",["$scope","$stateParams","$sce",
"$state","$ionicScrollDelegate",function(a,q,k,l,m){var g=firebase.firestore();firebase.auth().onAuthStateChanged(function(h){if(h&&null!=q.TestID){var f=function(d){clearInterval(p);if(d){for(d=1;d<=a.questions.length;d++)a.questions[d-1].answer==a.answer[d]&&(n+=1),d>=a.questions.length&&(a.test.Grade=n==a.questions.length?100:n*Math.round(100/a.questions.length));a.response=[{Grade:a.test.Grade,answer:a.answer}];g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(e).collection("\u4efb\u52d9\u5217\u8868").doc(b).get().then(function(d){d=
d.data().finished;d.push(c);g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(e).collection("\u4efb\u52d9\u5217\u8868").doc(b).update({finished:d}).then(function(){console.log("\u66f4\u65b0\u5df2\u5b8c\u6210\u540d\u55ae\u6210\u529f");a.$apply()})["catch"](function(a){console.error("\u66f4\u65b0\u5df2\u5b8c\u6210\u540d\u55ae\u5931\u6557",a)})})["catch"](function(a){console.log("\u53d6\u5f97\u5df2\u5b8c\u6210\u540d\u55ae\u767c\u751f\u932f\u8aa4\uff1a",a)})}else a.response=a.answer?[{answer:a.answer}]:[];
g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(e).collection("\u4efb\u52d9\u5217\u8868").doc(b).collection("\u586b\u7b54\u7d50\u679c").doc(c).set({StuID:c,missionID:b,response:a.response,time:new Date}).then(function(a){console.log("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u6210\u529f")})["catch"](function(a){console.error("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u5931\u6557\uff1a",a)})};console.log("\u5df2\u767b\u5165\u72c0\u614b");var c=h.email.substring(0,h.email.indexOf("@")).toUpperCase(),e=localStorage.getItem("ClassID"),
b=q.TestID;g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(e).collection("\u4efb\u52d9\u5217\u8868").doc(b).get().then(function(a){-1!=a.data().finished.indexOf(c)&&(console.log("\u5df2\u5b8c\u6210\u904e\u6e2c\u9a57"),l.go("login"))})["catch"](function(a){console.log("\u6aa2\u67e5\u662f\u5426\u5df2\u5b8c\u6210\u767c\u751f\u932f\u8aa4\uff1a",a)});a.test={};a.test.Name=q.TestName;a.test.Content=q.TestContent;var p,n=0;a.search="fkozq65K\u984c\u76ee\uff1a01";a.pageUpShow=!1;a.pageDownShow=!0;a.FinishBtnShow=
!1;a.testStart=!1;a.testContent=!0;a.testOver=!0;g.collection("IRS").doc(e).collection("\u6e2c\u9a57\u5217\u8868").doc(b).onSnapshot(function(b){function c(a){return 9>=a?"0"+String(a):a}var d=b.data().stageTime;a.distance=c(Math.floor(d/36E5))+":"+c(Math.floor(d%36E5/6E4))+":"+c(Math.floor(d%6E4/1E3));if(b.data().testStart){a.questions=b.data().questions;b=[];for(var e=0,n=a.questions.length;e<n;e++){var h=Math.floor(Math.random()*a.questions.length);b[e]=a.questions[h];a.questions.splice(h,1)}a.questions=
b;for(b=1;b<=a.questions.length;b++){var g;9>=b&&(g="0"+b);a.questions[b-1].search="fkozq65K\u984c\u76ee\uff1a"+g}a.testStart=!0;a.testContent=!1;a.pageUpDownShow=!0;a.$apply();p=setInterval(function(){d-=1E3;a.distance=c(Math.floor(d/36E5))+":"+c(Math.floor(d%36E5/6E4))+":"+c(Math.floor(d%6E4/1E3));a.$apply();0>=d&&1==a.testOver&&(f(!0),a.testStart=!0,a.testContent=!0,a.testOver=!1,a.pageUpDownShow=!1,m.scrollTop(),a.$apply())},1E3)}else f(!1),a.testStart=!1,a.testContent=!0,a.testOver=!0,a.pageUpDownShow=
!1,m.scrollTop(),a.$apply()},function(a){console.error("\u53d6\u5f97\u6e2c\u9a57\u8cc7\u6599\u767c\u751f\u932f\u8aa4\uff1a",a)});a.pageUp=function(b){b=b?parseInt(a.search.substr(11))-1:parseInt(a.search.substr(11))+1;9>=b&&(b="0"+b);a.search="fkozq65K\u984c\u76ee\uff1a"+b;b=a.questions.length;9>=b&&(b="0"+b);"fkozq65K\u984c\u76ee\uff1a01"==a.search?(a.pageUpShow=!1,a.pageDownShow=!0,a.FinishBtnShow=!1):a.search=="fkozq65K\u984c\u76ee\uff1a"+b?(a.pageUpShow=!0,a.pageDownShow=!1,a.FinishBtnShow=!0):
(a.pageUpShow=!0,a.pageDownShow=!0,a.FinishBtnShow=!1);f(!1)};a.testFinishBtn=function(){f(!0);a.testStart=!0;a.testContent=!0;a.testOver=!1;a.pageUpDownShow=!1;m.scrollTop()};a.answerChange=function(b){ary=[];for(p in b)ary[ary.length]=p;a.answer=b;a.answerAry=ary}}else console.log("\u5c1a\u672a\u767b\u5165"),l.go("login")})}]).controller("brainstormingCtrl",["$scope","$stateParams","$state","$ionicScrollDelegate","$ionicLoading","$ionicPopup",function(a,q,k,l,m,g){var h=firebase.firestore();firebase.auth().onAuthStateChanged(function(f){if(f){console.log("\u5df2\u767b\u5165\u72c0\u614b");
var c=f.email.substring(0,f.email.indexOf("@")).toUpperCase(),e=localStorage.getItem("StuName"),b=localStorage.getItem("ClassID"),p=localStorage.getItem("GroupID");a.search="fkozq65K\u9801\u7c64\uff1a1";a.tabs=function(c){if("+"==c)10<=a.tabsCounts.length?g.confirm({title:"\u65b0\u589e\u5206\u9801",template:"\u5206\u9801\u5df2\u5230\u4e0a\u9650(10\u9801)\u3002",buttons:[{text:"\u597d\u7684",type:"button-chanry1",onTap:function(a){}}]}):g.confirm({title:"\u65b0\u589e\u5206\u9801",template:"\u78ba\u5b9a\u8981\u65b0\u589e\u55ce?",
subTitle:"\u6ce8\u610f\uff1a\u65b0\u589e\u5f8c\u7121\u6cd5\u522a\u9664\uff0c\u4e0a\u9650\u70ba10\u500b\u5206\u9801\u3002",buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u78ba\u5b9a",type:"button-chanry1",onTap:function(c){console.log("\u9078\u64c7\u65b0\u589e");h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc("\u9801\u7c64").update({count:a.tabsCounts.length+1}).then(function(){console.log("\u65b0\u589e\u5206\u9801\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589e\u5206\u9801\u5931\u6557",
a)})}}]});else{a.search="fkozq65K\u9801\u7c64\uff1a"+c;var d=a.tabsCounts.findIndex(function(a){return!0===a.active});a.tabsCounts[d].num=d+1;a.tabsCounts[d].active=!1;a.tabsCounts[c-1].num=c;a.tabsCounts[c-1].active=!0}};h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc("\u9801\u7c64").onSnapshot(function(c){if(c.exists){a.tabsCounts=[];for(var d=1;d<=c.data().count;d++)1==d?a.tabsCounts.push({num:d,active:!0}):a.tabsCounts.push({num:d,active:!1});a.$apply()}else h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc("\u9801\u7c64").set({count:3}).then(function(){console.log("\u521d\u59cb\u5316\u5206\u9801\u6210\u529f")})["catch"](function(a){console.error("\u521d\u59cb\u5316\u5206\u9801\u5931\u6557",
a)})});a.items=[];h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).orderBy("time","asc").onSnapshot({includeMetadataChanges:!0},function(b){b.docChanges().forEach(function(b){if("added"===b.type){var e=b.doc.data();e.ID=b.doc.id;-1!=e.like.indexOf(c)?e.likeBtn=!0:e.likeBtn=!1;a.items.push(e);a.$apply();l.scrollBottom();console.log("\u65b0\u589e: ",e)}if("modified"===b.type){e=b.doc.data();e.ID=b.doc.id;-1!=e.like.indexOf(c)?e.likeBtn=!0:e.likeBtn=!1;var d=a.items.findIndex(function(a){return a.time.seconds===
b.doc.data().time.seconds&a.time.nanoseconds===b.doc.data().time.nanoseconds});-1!=d?(a.items.splice(d,1,e),console.log("\u4fee\u6539\u5217\u8868\u6210\u529f")):console.log("\u4fee\u6539\u5217\u8868\u4e0d\u6210\u529f");a.$apply();console.log("\u4fee\u6539: ",b.doc.data())}"removed"===b.type&&(console.log("\u522a\u9664: ",b.doc.data()),d=a.items.findIndex(function(a){return a.time.seconds===b.doc.data().time.seconds&a.time.nanoseconds===b.doc.data().time.nanoseconds}),-1!=d?(a.items.splice(d,1),console.log("\u522a\u9664\u5217\u8868\u6210\u529f")):
console.log("\u522a\u9664\u5217\u8868\u4e0d\u6210\u529f"),a.$apply())})});a.add=function(){m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u65b0\u589e\u4e2d...</p>'});void 0!=a.input&&""!=a.input&&(h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).add({StuID:c,StuName:e,msg:a.input,like:[],invited:!1,search:a.search,time:new Date}).then(function(a){console.log("\u65b0\u589e\u8166\u529b\u6fc0\u76ea\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589e\u8166\u529b\u6fc0\u76ea\u5931\u6557\uff1a",
a)}),a.input="");m.hide()};a.Delete=function(a){m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u522a\u9664\u4e2d...</p>'});h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).where("time","==",a.time).get().then(function(a){a.forEach(function(a){h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc(a.id)["delete"]().then(function(){console.log("\u522a\u9664\u8166\u529b\u6fc0\u76ea\u6210\u529f")})["catch"](function(a){console.error("\u522a\u9664\u8166\u529b\u6fc0\u76ea\u5931\u6557\uff1a",
a)})})});m.hide()};a.like=function(a){1==a.likeBtn?(a.like.splice(a.like.indexOf(c),1),h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc(a.ID).update({like:a.like}).then(function(a){console.log("\u66f4\u65b0\u6309\u8b9a\u72c0\u614b\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u6309\u8b9a\u72c0\u614b\u5931\u6557\uff1a",a)})):(a.like.push(c),h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc(a.ID).update({like:a.like}).then(function(a){console.log("\u66f4\u65b0\u6309\u8b9a\u72c0\u614b\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u6309\u8b9a\u72c0\u614b\u5931\u6557\uff1a",
a)}))};h.collection("\u5206\u7d44").doc(b).collection("group").where("leader","==",c).get().then(function(b){b.empty?(console.log("\u4f60\u975e\u7d44\u9577"),a.DelAllBtnShow=!1):(console.log("\u4f60\u662f\u7d44\u9577"),a.DelAllBtnShow=!0)})["catch"](function(a){console.log("\u5224\u65b7\u7d44\u9577\u767c\u751f\u932f\u8aa4\uff1a",a)});a.DelAllBtn=function(){g.confirm({title:"\u6e05\u7a7a\u8166\u529b\u6fc0\u76ea\u8cc7\u6599",template:"\u78ba\u5b9a\u8981\u6e05\u7a7a\u55ce?",subTitle:"\u6ce8\u610f\uff1a\u6e05\u7a7a\u6703\u522a\u9664\u5168\u9ad4\u7d44\u54e1\u8166\u529b\u6fc0\u76ea\u8cc7\u6599\u3002",
buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u78ba\u5b9a",type:"button-chanry1",onTap:function(a){console.log("\u9078\u64c7\u6e05\u7a7a");h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).get().then(function(a){a.forEach(function(a){h.collection("\u8166\u529b\u6fc0\u76ea").doc(b).collection(p).doc(a.id)["delete"]().then(function(){console.log("\u522a\u9664\u8166\u529b\u6fc0\u76ea\u6210\u529f")})["catch"](function(a){console.error("\u522a\u9664\u8166\u529b\u6fc0\u76ea\u5931\u6557\uff1a",
a)})})})["catch"](function(a){console.log("\u67e5\u8a62\u5168\u90e8\u8a0a\u606f\u767c\u751f\u932f\u8aa4\uff1a",a)})}}]})}}else console.log("\u5c1a\u672a\u767b\u5165"),k.go("login")})}]).controller("proposalCtrl",["$scope","$stateParams","$state","$ionicPopup","$ionicLoading","$ionicScrollDelegate",function(a,q,k,l,m,g){var h=firebase.firestore();firebase.auth().onAuthStateChanged(function(f){if(f){console.log("\u5df2\u767b\u5165\u72c0\u614b");var c=f.email.substring(0,f.email.indexOf("@")).toUpperCase();
localStorage.getItem("StuName");var e=localStorage.getItem("ClassID"),b=localStorage.getItem("GroupID");h.collection("\u5206\u7d44").doc(e).collection("group").where("leader","==",c).get().then(function(b){b.empty?(console.log("\u4f60\u975e\u7d44\u9577"),a.leaderGroupShow=!1):(console.log("\u4f60\u662f\u7d44\u9577"),a.leaderGroupShow=!0)})["catch"](function(a){console.log("\u5224\u65b7\u7d44\u9577\u767c\u751f\u932f\u8aa4\uff1a",a)});a.items=[];h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).orderBy("time",
"asc").onSnapshot({includeMetadataChanges:!0},function(c){c.docChanges().forEach(function(c){if("added"===c.type){var d=c.doc.data(),n=[];d.brainstorming.forEach(function(c){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(c).get().then(function(b){n.push(b.data());a.$apply()})["catch"](function(a){console.log("\u8166\u529b\u6fc0\u76ea\u5167\u5bb9\u767c\u751f\u932f\u8aa4\uff1a",a)})});a.items.push({ProposalName:d.ProposalName,brainstorming:n,time:d.time});g.scrollBottom();console.log("\u65b0\u589e: ",
a.items)}else"modified"===c.type?(console.log("\u4fee\u6539: ",c.doc.data()),d=c.doc.data(),n=[],d.brainstorming.forEach(function(c){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(c).get().then(function(b){n.push(b.data());a.$apply()})["catch"](function(a){console.log("\u8166\u529b\u6fc0\u76ea\u5167\u5bb9\u767c\u751f\u932f\u8aa4\uff1a",a)})}),d=a.items.findIndex(function(a){return a.time.seconds===c.doc.data().time.seconds&a.time.nanoseconds===c.doc.data().time.nanoseconds}),a.items[d].brainstorming=
n,a.$apply()):"removed"===c.type&&(console.log("\u522a\u9664: ",c.doc.data()),d=a.items.findIndex(function(a){return a.time.seconds===c.doc.data().time.seconds&a.time.nanoseconds===c.doc.data().time.nanoseconds}),-1!=d?(a.items.splice(d,1),console.log("\u522a\u9664\u5217\u8868\u6210\u529f")):console.log("\u522a\u9664\u5217\u8868\u4e0d\u6210\u529f"),a.$apply())})});a.bells=[];var p,n="";a.bellProposal=function(d){a.bells=[];m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u8f09\u5165\u63d0\u8b70\u4e2d...</p>'});
h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).where("time","==",d).get().then(function(d){d.forEach(function(d){n=d.id;p=h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).collection("\u63d0\u8b70").where("solve","==",!1).onSnapshot(function(d){if(d.empty)console.log("\u76ee\u524d\u7121\u63d0\u8b70"),a.bells=[],m.hide();else{var n=d.docs.length,g=0;d.docChanges().forEach(function(d){if("added"===d.type){var f=[];d.doc.data().brainstorming.forEach(function(c){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(c).get().then(function(b){f.push({brainstormingID:b.id,
msg:b.data().msg});a.$apply()})["catch"](function(a){console.log("\u53d6\u5f97\u8166\u529b\u6fc0\u76ea\u5167\u5bb9\u767c\u751f\u932f\u8aa4\uff1a",a)})});var p=!1,k=!1;-1!=d.doc.data().voteN.indexOf(c)?p=!0:-1!=d.doc.data().voteY.indexOf(c)&&(k=!0);a.bells.push({bellID:d.doc.id,bellTime:d.doc.data().time,voteN:d.doc.data().voteN,voteY:d.doc.data().voteY,voteChooseN:p,voteChooseY:k,time:d.doc.data().time,bellBrainstorming:f});g++;g==n&&m.hide();a.$apply();console.log("\u65b0\u589e\uff1a",d.doc.data())}if("modified"===
d.type){k=p=!1;-1!=d.doc.data().voteN.indexOf(c)?p=!0:-1!=d.doc.data().voteY.indexOf(c)&&(k=!0);var l=a.bells.findIndex(function(a){return a.bellID===d.doc.id});a.bells[l].voteN=d.doc.data().voteN;a.bells[l].voteY=d.doc.data().voteY;a.bells[l].voteChooseN=p;a.bells[l].voteChooseY=k;a.$apply();console.log("\u4fee\u6539\uff1a",d.doc.data())}"removed"===d.type&&(l=a.bells.findIndex(function(a){return a.time.seconds===d.doc.data().time.seconds&a.time.nanoseconds===d.doc.data().time.nanoseconds}),-1!=
l?(a.bells.splice(l,1),console.log("\u522a\u9664\u5217\u8868\u6210\u529f")):console.log("\u522a\u9664\u5217\u8868\u4e0d\u6210\u529f"),a.$apply(),console.log("\u522a\u9664\uff1a",d.doc.data()))})}},function(a){console.log("\u53d6\u5f97\u63d0\u8b70\u767c\u751f\u932f\u8aa4\uff1a",a)})})})["catch"](function(a){console.log("\u53d6\u5f97\u63d0\u6848ID\u767c\u751f\u932f\u8aa4\uff1a",a)});l.show({title:"\u7d44\u54e1\u63d0\u8b70\u4e4b\u8166\u529b\u6fc0\u76ea",subTitle:"\u8acb\u9032\u884c\u6295\u7968\uff0c\u8d0a\u6210\u904e\u534a\u81ea\u52d5\u6210\u7acb\uff0c\u53cd\u4e4b\u5426\u6c7a\u63d0\u8b70\u3002",
template:'<div ng-repeat="bell in bells"><div class="item item-divider">\u3010\u533f\u540d\u3011\u63d0\u8b70\u52a0\u5165\u4ee5\u4e0b\u8166\u529b\u6fc0\u76ea</div><div ng-repeat="bellBrainstorming in bell.bellBrainstorming"><div class="item">{{$index+1}}.{{bellBrainstorming.msg}}</div></div><div class="item vote"><div class="voteN" style="width:{{bell.voteN.length / (bell.voteN.length + bell.voteY.length) * 100}}%"></div><span class="votespan" style="left:16px;">\u53cd\u5c0d\uff1a{{bell.voteN.length}}</span><span class="votespan" style="right:16px;">\u8d0a\u6210\uff1a{{bell.voteY.length}}</span></div><div class="item row VoteHeight"><div class="col col-50"><i ng-click="votebtn(\'N\',bell.bellID)" ng-class="{true:\'voteChooseN\',false:\'voteNbtn\'}[bell.voteChooseN]" ></i></div><div class="col col-50"><i ng-click="votebtn(\'Y\',bell.bellID)" ng-class="{true:\'voteChooseY\',false:\'voteYbtn\'}[bell.voteChooseY]" ></i></div></div><div class="spacer" style="height: 20px;"></div></div>',
scope:a,buttons:[{text:"\u95dc\u9589",type:"button-chanry1",onTap:function(a){console.log("\u9078\u64c7\u95dc\u9589");p()}}]})};a.votebtn=function(d,g){var f=a.bells.findIndex(function(a){return a.bellID===g});-1!=f?("N"==d?-1!=a.bells[f].voteN.indexOf(c)?(a.bells[f].voteN.splice(a.bells[f].voteN.indexOf(c),1),a.bells[f].voteChooseN=!1):(a.bells[f].voteN.push(c),a.bells[f].voteChooseN=!0,-1!=a.bells[f].voteY.indexOf(c)&&(a.bells[f].voteY.splice(a.bells[f].voteY.indexOf(c),1),a.bells[f].voteChooseY=
!1)):"Y"==d&&(-1!=a.bells[f].voteY.indexOf(c)?(a.bells[f].voteY.splice(a.bells[f].voteY.indexOf(c),1),a.bells[f].voteChooseY=!1):(a.bells[f].voteY.push(c),a.bells[f].voteChooseY=!0,-1!=a.bells[f].voteN.indexOf(c)&&(a.bells[f].voteN.splice(a.bells[f].voteN.indexOf(c),1),a.bells[f].voteChooseN=!1))),h.collection("\u5206\u7d44").doc(e).collection("group").doc(b).get().then(function(c){c=c.data().members.length;a.bells[f].voteN.length>c/2||a.bells[f].voteN.length==a.bells[f].voteY.length&&a.bells[f].voteY.length==
c/2?(console.log("\u5426\u6c7a\u63d0\u8b70or\u5e73\u624b"),h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).collection("\u63d0\u8b70").doc(g).update({solve:!0}).then(function(b){console.log("\u95dc\u9589\u63d0\u8b70\u6210\u529f");a.$apply()})["catch"](function(a){console.error("\u95dc\u9589\u63d0\u8b70\u5931\u6557\uff1a",a)})):a.bells[f].voteY.length>c/2&&(console.log("\u63d0\u8b70\u6210\u7acb"),h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).get().then(function(c){var d=
[];a.bells[f].bellBrainstorming.forEach(function(a){d.push(a.brainstormingID)});c=c.data().brainstorming.concat(d).concat();for(var p=0;p<c.length;++p)for(var k=p+1;k<c.length;++k)c[p]===c[k]&&c.splice(k,1);h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).update({brainstorming:c}).then(function(c){console.log("\u66f4\u65b0\u63d0\u6848\u6210\u529f");d.forEach(function(c){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(c).update({invited:!0}).then(function(a){console.log("\u6a19\u8a18\u63d0\u6848\u6210\u529f")})["catch"](function(a){console.error("\u6a19\u8a18\u63d0\u6848\u5931\u6557\uff1a",
a)});h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).collection("\u63d0\u8b70").doc(g).update({solve:!0}).then(function(b){console.log("\u95dc\u9589\u63d0\u8b70\u6210\u529f");a.$apply()})["catch"](function(a){console.error("\u95dc\u9589\u63d0\u8b70\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.error("\u66f4\u65b0\u63d0\u6848\u5931\u6557\uff1a",a)})})["catch"](function(a){console.log("\u53d6\u5f97\u63d0\u6848\u805a\u7126\u5167\u8166\u529b\u6fc0\u76ea\u9663\u5217\u767c\u751f\u932f\u8aa4\uff1a",
a)}))})["catch"](function(a){console.log("\u53d6\u5f97\u7d44\u54e1\u4eba\u6578\u767c\u751f\u932f\u8aa4\uff1a",a)}),h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(n).collection("\u63d0\u8b70").doc(g).update({voteN:a.bells[f].voteN,voteY:a.bells[f].voteY}).then(function(a){console.log("\u66f4\u65b0\u4f3a\u670d\u5668\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u4f3a\u670d\u5668\u5931\u6557\uff1a",a)})):console.log("\u53d6\u5f97\u8a72bell\u5931\u6557")};a.AddProposal=
function(d,f){a.proposals=[];m.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u8f09\u5165\u8166\u529b\u6fc0\u76ea\u4e2d...</p>'});h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).where("invited","==",!1).get().then(function(b){if(b.empty)console.log("\u5168\u90fd\u5df2\u65b0\u589eor\u7121\u8166\u529b\u6fc0\u76ea"),m.hide();else{var c=b.docs.length,d=0;b.forEach(function(b){a.proposals.push({ID:b.id,msg:b.data().msg,like:b.data().like.length,search:Number(b.data().search.substr(11))});
d++;d==c&&m.hide()});console.log("\u53d6\u5f97\u8166\u529b\u6fc0\u76ea\u540d\u55ae\uff1a",a.proposals)}})["catch"](function(a){console.log("\u53d6\u5f97\u672a\u5206\u7d44\u540d\u55ae\u767c\u751f\u932f\u8aa4\uff1a",a)});var g=[];a.proposalsForFilter=function(){g=[];return a.proposals};a.searchFilter=function(a){var b=-1==g.indexOf(a.search);b&&g.push(a.search);return b};a.checkProposals=[];a.proposalBtn=function(b){-1===a.checkProposals.indexOf(b)?a.checkProposals.push(b):a.checkProposals.splice(a.checkProposals.indexOf(b),
1);console.log(a.checkProposals)};a.proposalInput=[];"Add"==d?l.show({title:"\u65b0\u589e\u63d0\u6848",subTitle:"\u8acb\u9078\u64c7\u52a0\u5165\u63d0\u6848\u4e4b\u8166\u529b\u6fc0\u76ea\u3002",template:'<input type="text" ng-model="proposalInput.content" placeholder="\u8f38\u5165\u63d0\u6848\u6a19\u984c\uff08\u965015\u5b57\u5167\uff09..." maxlength="15" style="margin-bottom:10px; padding:8px;"><div ng-repeat="proposalsPerSearch in proposalsForFilter() | filter:searchFilter | orderBy:\'search\'"><div class="item item-divider">\u8166\u529b\u6fc0\u76ea{{proposalsPerSearch.search}}</div><div ng-repeat="proposal in proposals | filter:{search:proposalsPerSearch.search} | orderBy:\'-like\' "><ion-checkbox ng-click="proposalBtn(proposal.ID)">{{proposal.like}}\u8b9a\uff1a{{proposal.msg}}</ion-checkbox></div></div>',
scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u65b0\u589e",type:"button-chanry1",onTap:function(c){console.log("\u9078\u64c7\u65b0\u589e");""==a.proposalInput.content||void 0==a.proposalInput.content?(console.log("\u8acb\u586b\u5beb\u63d0\u6848\u6a19\u984c"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u586b\u5beb\u63d0\u6848\u6a19\u984c\u3002"})):0==a.checkProposals.length?(console.log("\u8acb\u52fe\u9078\u8166\u529b\u6fc0\u76ea"),
l.alert({title:"\u932f\u8aa4",template:"\u8acb\u52fe\u9078\u81f3\u5c11\u4e00\u9805\u8166\u529b\u6fc0\u76ea\u3002"})):h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).add({ProposalName:a.proposalInput.content,brainstorming:a.checkProposals,time:new Date}).then(function(c){console.log("\u65b0\u589e\u63d0\u6848\u6210\u529f");a.checkProposals.forEach(function(a){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(a).update({invited:!0}).then(function(a){console.log("\u6a19\u8a18\u63d0\u6848\u6210\u529f")})["catch"](function(a){console.error("\u6a19\u8a18\u63d0\u6848\u5931\u6557\uff1a",
a)})})})["catch"](function(a){console.error("\u65b0\u589e\u63d0\u6848\u5931\u6557\uff1a",a)})}}]}):"Invite"==d&&(a.leaderGroupShow?l.show({title:"\u52a0\u5165\u8166\u529b\u6fc0\u76ea",subTitle:"\u8acb\u9078\u64c7\u52a0\u5165\u6b64\u63d0\u6848\u4e4b\u8166\u529b\u6fc0\u76ea\u3002",template:'<div ng-repeat="proposalsPerSearch in proposalsForFilter() | filter:searchFilter | orderBy:\'search\'"><div class="item item-divider">\u8166\u529b\u6fc0\u76ea{{proposalsPerSearch.search}}</div><div ng-repeat="proposal in proposals | filter:{search:proposalsPerSearch.search} | orderBy:\'-like\' "><ion-checkbox ng-click="proposalBtn(proposal.ID)">{{proposal.like}}\u8b9a\uff1a{{proposal.msg}}</ion-checkbox></div></div>',
scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u52a0\u5165",type:"button-chanry1",onTap:function(c){console.log("\u9078\u64c7\u52a0\u5165");0==a.checkProposals.length?(console.log("\u8acb\u52fe\u9078\u8166\u529b\u6fc0\u76ea"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u52fe\u9078\u81f3\u5c11\u4e00\u9805\u8166\u529b\u6fc0\u76ea\u3002"})):h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).where("time","==",
f).get().then(function(c){c.forEach(function(c){var d=c.id;h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(d).get().then(function(c){h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(d).update({brainstorming:c.data().brainstorming.concat(a.checkProposals)}).then(function(c){console.log("\u66f4\u65b0\u63d0\u6848\u6210\u529f");a.checkProposals.forEach(function(a){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(a).update({invited:!0}).then(function(a){console.log("\u6a19\u8a18\u63d0\u6848\u6210\u529f")})["catch"](function(a){console.error("\u6a19\u8a18\u63d0\u6848\u5931\u6557\uff1a",
a)})})})["catch"](function(a){console.error("\u66f4\u65b0\u63d0\u6848\u5931\u6557\uff1a",a)})})["catch"](function(a){console.log("\u53d6\u5f97\u63d0\u6848\u805a\u7126\u5167\u8166\u529b\u6fc0\u76ea\u9663\u5217\u767c\u751f\u932f\u8aa4\uff1a",a)})})})["catch"](function(a){console.log("\u67e5\u8a62\u5168\u90e8\u8a0a\u606f\u767c\u751f\u932f\u8aa4\uff1a",a)})}}]}):l.show({title:"\u63d0\u8b70\u52a0\u5165\u4e4b\u8166\u529b\u6fc0\u76ea",subTitle:"\u63d0\u8b70\u5f8c\u9700\u7b49\u7d44\u9577\u540c\u610f\u624d\u53ef\u52a0\u5165\u3002",
template:'<div ng-repeat="proposalsPerSearch in proposalsForFilter() | filter:searchFilter | orderBy:\'search\'"><div class="item item-divider">\u8166\u529b\u6fc0\u76ea{{proposalsPerSearch.search}}</div><div ng-repeat="proposal in proposals | filter:{search:proposalsPerSearch.search} | orderBy:\'-like\' "><ion-checkbox ng-click="proposalBtn(proposal.ID)">{{proposal.like}}\u8b9a\uff1a{{proposal.msg}}</ion-checkbox></div></div>',scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},
{text:"\u63d0\u8b70",type:"button-chanry1",onTap:function(d){console.log("\u9078\u64c7\u63d0\u8b70");0==a.checkProposals.length?(console.log("\u8acb\u52fe\u9078\u8166\u529b\u6fc0\u76ea"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u52fe\u9078\u81f3\u5c11\u4e00\u9805\u8166\u529b\u6fc0\u76ea\u3002"})):h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).where("time","==",f).get().then(function(d){d.forEach(function(d){d=d.id;h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(d).collection("\u63d0\u8b70").add({StuID:c,
brainstorming:a.checkProposals,voteY:[c],voteN:[],solve:!1,time:new Date}).then(function(a){console.log("\u65b0\u589ebell\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589ebell\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.log("\u67e5\u8a62\u5168\u90e8\u8a0a\u606f\u767c\u751f\u932f\u8aa4\uff1a",a)})}}]}))};a.DelBrainstorming=function(a,c){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).where("time","==",c).get().then(function(c){c.forEach(function(c){var d=c.id;
h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).where("time","==",a).get().then(function(a){a.forEach(function(a){var c=a.data().brainstorming;c.splice(c.indexOf(d),1);h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(a.id).update({brainstorming:c}).then(function(a){console.log("\u66f4\u65b0\u8a72\u63d0\u6848\u4e4b\u8166\u529b\u6fc0\u76ea\u6e05\u55ae\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0\u8a72\u63d0\u6848\u4e4b\u8166\u529b\u6fc0\u76ea\u6e05\u55ae\u5931\u6557\uff1a",
a)});h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(d).update({invited:!1}).then(function(a){console.log("\u6a19\u8a18\u63d0\u6848\u6210\u529f")})["catch"](function(a){console.error("\u6a19\u8a18\u63d0\u6848\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.log("\u53d6\u5f97\u8a72\u63d0\u6848\u4e4b\u8166\u529b\u6fc0\u76ea\u6e05\u55ae\u767c\u751f\u932f\u8aa4\uff1a",a)})})})["catch"](function(a){console.log("\u53d6\u5f97\u8166\u529b\u6fc0\u76eaID\u767c\u751f\u932f\u8aa4\uff1a",
a)})};a.DelProposal=function(a){l.confirm({title:"\u522a\u9664\u63d0\u6848",template:"\u78ba\u5b9a\u8981\u522a\u9664\u6b64\u63d0\u6848\u55ce?",buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u78ba\u5b9a",type:"button-chanry1",onTap:function(c){console.log("\u9078\u64c7\u522a\u9664");h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).where("time","==",a).get().then(function(a){a.forEach(function(a){h.collection("\u63d0\u6848\u805a\u7126").doc(e).collection(b).doc(a.id)["delete"]().then(function(){console.log("\u522a\u9664\u63d0\u6848\u805a\u7126\u6210\u529f");
a.data().brainstorming.forEach(function(a){h.collection("\u8166\u529b\u6fc0\u76ea").doc(e).collection(b).doc(a).update({invited:!1}).then(function(a){console.log("\u6a19\u8a18\u63d0\u6848\u6210\u529f")})["catch"](function(a){console.error("\u6a19\u8a18\u63d0\u6848\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.error("\u522a\u9664\u63d0\u6848\u805a\u7126\u5931\u6557\uff1a",a)})})})["catch"](function(a){console.log("\u67e5\u8a62\u5168\u90e8\u8a0a\u606f\u767c\u751f\u932f\u8aa4\uff1a",a)})}}]})}}else console.log("\u5c1a\u672a\u767b\u5165"),
k.go("login")})}]).controller("settingCtrl",["$scope","$stateParams","$ionicLoading","$ionicPopup",function(a,q,k,l){var m=firebase.firestore();firebase.auth().onAuthStateChanged(function(g){if(g){console.log("\u5df2\u767b\u5165\u72c0\u614b");var h=g.email.substring(0,g.email.indexOf("@")).toUpperCase(),f=localStorage.getItem("ClassID");a.Passward=function(){l.show({title:"\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1",template:"\u78ba\u5b9a\u8981\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u55ce?",buttons:[{text:"\u53d6\u6d88",
type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u78ba\u5b9a",type:"button-chanry1",onTap:function(a){console.log("\u9078\u64c7\u78ba\u5b9a");k.show({template:"\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u4e2d..."});firebase.auth().sendPasswordResetEmail(h+"@nkust.edu.tw").then(function(){console.log("\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u6210\u529f");l.alert({title:"\u6210\u529f",template:"\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u6210\u529f\uff0c\u8acb\u81f3 "+
h+"@nkust.edu.tw \u6536\u4fe1"});k.hide()})["catch"](function(a){console.log("\u5bc4\u9001\u5bc6\u78bc\u91cd\u7f6e\u4fe1\u5931\u6557\uff1a",a);k.hide()})}}]})};a.myImage="";a.myCroppedImage="";angular.element(document.querySelector("#uploadFileInput2")).on("change",function(c){c=c.currentTarget.files[0];var e=new FileReader;e.onload=function(b){a.$apply(function(a){a.myImage=b.target.result})};e.readAsDataURL(c)});a.ChangeImg=function(c){k.show({template:"\u4e0a\u50b3\u5716\u7247\u4e2d..."});if(""==
c)console.log("\u672a\u9078\u64c7\u6a94\u6848"),k.hide(),l.alert({title:"\u672a\u9078\u64c7\u6a94\u6848",template:"\u8acb\u5148\u9078\u64c7\u6a94\u6848\u518d\u4e0a\u50b3"});else{var e=firebase.storage().ref(),b=new Date,f=h+b.getFullYear().toString()+b.getMonth()+b.getDate()+b.getHours()+b.getMinutes()+b.getSeconds()+b.getMilliseconds();e.child("members/"+f).putString(c,"data_url").on("state_changed",function(a){k.show({template:"\u5df2\u4e0a\u50b3 "+a.bytesTransferred/a.totalBytes*100+"%"});switch(a.state){case firebase.storage.TaskState.PAUSED:console.log("\u4e0a\u50b3\u66ab\u505c");
break;case firebase.storage.TaskState.RUNNING:console.log("\u4e0a\u50b3\u4e2d")}},function(b){console.log("\u4e0a\u50b3\u5931\u6557");k.hide();console.log(b);l.alert({title:"\u4e0a\u50b3\u5716\u7247\u5931\u6557",template:b});a.myImage="";a.myCroppedImage=""},function(){console.log("\u4e0a\u50b3\u6210\u529f");k.hide();a.myImage="";a.myCroppedImage="";e.child("members/"+f).getDownloadURL().then(function(a){document.getElementById("menu-img").src=a});m.collection("\u5e33\u865f").doc(h).update({Img:f}).then(function(a){console.log("\u66f4\u65b0DB\u6a94\u540d\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0DB\u6a94\u540d\u5931\u6557\uff1a",
a)});l.alert({title:"\u6210\u529f",template:"\u66f4\u63db\u7167\u7247\u5b8c\u6210\u3002"})})}};a.BugBtn=function(a){""==a||void 0==a?(console.log("\u8acb\u586b\u5beb\u5b8c\u6574"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u586b\u5beb\u5b8c\u6574\u3002"})):m.collection("\u7cfb\u7d71\u8a18\u9304").doc(f).collection("BUG\u56de\u5831").add({StuID:h,Content:a,time:new Date}).then(function(a){console.log("\u56de\u50b3\u4f3a\u670d\u5668\u6210\u529f");l.alert({title:"\u6210\u529f",template:"\u56de\u5831\u6210\u529f\uff0c\u611f\u8b1d\u60a8\u3002"})})["catch"](function(a){console.error("\u56de\u50b3\u4f3a\u670d\u5668\u5931\u6557\uff1a",
a);l.alert({title:"\u5931\u6557",template:"\u56de\u5831\u5931\u6557\uff0c\u8acb\u7a0d\u5019\u518d\u8a66\u3002"+a})})}}else console.log("\u5c1a\u672a\u767b\u5165"),$state.go("login")})}]).controller("menuCtrl",["$scope","$stateParams","$ionicPopup","$state",function(a,q,k,l){var m=firebase.firestore();firebase.auth().onAuthStateChanged(function(g){if(g){console.log("\u5df2\u767b\u5165\u72c0\u614b");var h=g.email.substring(0,g.email.indexOf("@")).toUpperCase(),f=localStorage.getItem("ClassID");m.collection("\u5e33\u865f").doc(h).get().then(function(a){document.getElementById("menu-heading1").innerText=
h+" "+a.data().Name;localStorage.setItem("StuName",a.data().Name)})["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});document.getElementById("menu-list-item8").addEventListener("click",function(){firebase.auth().signOut().then(function(){console.log("\u767b\u51fa\u6210\u529f");localStorage.clear()})["catch"](function(a){console.log("\u767b\u51fa\u767c\u751f\u932f\u8aa4!")})},!1);m.collection("\u5e33\u865f").doc(h).get().then(function(a){console.log("\u66f4\u65b0\u5927\u982d\u7167\u6210\u529f");
firebase.storage().ref().child("members/"+a.data().Img).getDownloadURL().then(function(a){document.getElementById("menu-img").src=a})})["catch"](function(a){console.log("\u67e5\u8a62\u5716\u7247\u6a94\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});document.getElementById("menu-heading2").innerText="Copyright \u00a9 2019 ver "+verson;m.collection("\u5206\u7d44").doc(f).collection("student").doc(h).collection("invite").where("respond","==",!1).onSnapshot(function(c){c.forEach(function(c){console.log("\u6709\u4eba\u9080\u8acb");
var b=c.data().groupID,e=c.id,g=c.data().leader;m.collection("\u5e33\u865f").doc(g).get().then(function(c){c=c.data().Name;k.show({title:"\u5c0f\u7d44\u9080\u8acb",subTitle:g+" "+c+" \u9080\u8acb\u4f60\u52a0\u5165\u5c0f\u7d44\u3002",template:'<img class="inviteImg" src="img/invite.jpg">',scope:a,buttons:[{text:"\u62d2\u7d55",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u62d2\u7d55");m.collection("\u5206\u7d44").doc(f).collection("student").doc(h).collection("invite").doc(e).update({respond:!0}).then(function(a){console.log("\u66f4\u65b0\u56de\u61c9\u72c0\u614b\u6210\u529f");
m.collection("\u5206\u7d44").doc(f).collection("group").doc(b).get().then(function(a){a=a.data().inviting;a.splice(a.indexOf(h),1);m.collection("\u5206\u7d44").doc(f).collection("group").doc(b).update({inviting:a}).then(function(a){console.log("\u66f4\u65b0inviting\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0inviting\u5931\u6557\uff1a",a)})})["catch"](function(a){console.log("\u6aa2\u67e5\u5c0f\u7d44\u662f\u5426\u9084\u5b58\u5728\uff0c\u53ef\u80fd\u5c0f\u7d44\u5df2\u89e3\u6563\uff1a",
a)})})["catch"](function(a){console.error("\u66f4\u65b0\u56de\u61c9\u72c0\u614b\u5931\u6557\uff1a",a)})}},{text:"\u63a5\u53d7",type:"button-chanry1",onTap:function(a){console.log("\u9078\u64c7\u63a5\u53d7");m.collection("\u5206\u7d44").doc(f).collection("student").doc(h).collection("invite").doc(e).update({respond:!0}).then(function(a){console.log("\u66f4\u65b0\u56de\u61c9\u72c0\u614b\u6210\u529f");m.collection("\u5206\u7d44").doc(f).collection("student").doc(h).update({grouped:!0}).then(function(a){console.log("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u6210\u529f");
m.collection("\u5206\u7d44").doc(f).collection("group").doc(b).get().then(function(a){var c=a.data().inviting;a=a.data().members;c.splice(c.indexOf(h),1);a.push(h);m.collection("\u5206\u7d44").doc(f).collection("group").doc(b).update({inviting:c,members:a}).then(function(a){console.log("\u66f4\u65b0inviting\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0inviting\u5931\u6557\uff1a",a)})})["catch"](function(a){console.log("\u6aa2\u67e5\u5c0f\u7d44\u662f\u5426\u9084\u5b58\u5728\uff0c\u53ef\u80fd\u5c0f\u7d44\u5df2\u89e3\u6563\uff1a",
a)})})["catch"](function(a){console.error("\u66f4\u65b0\u5165\u7d44\u72c0\u614b\u5931\u6557\uff1a",a)})})["catch"](function(a){console.error("\u66f4\u65b0\u56de\u61c9\u72c0\u614b\u5931\u6557\uff1a",a)})}}]})})["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)})})},function(a){console.log("\u641c\u5c0b\u662f\u5426\u6709\u4eba\u9080\u8acb\u767c\u751f\u932f\u8aa4\uff1a",a)});m.collection("\u5206\u7d44").doc(f).collection("group").where("members","array-contains",
h).onSnapshot(function(c){0==c.empty?(console.log("\u9078\u55ae - \u5df2\u52a0\u5165\u5c0f\u7d44"),c.forEach(function(c){localStorage.setItem("GroupID",c.id);GroupID=c.id;a.needGroup=!0})):(console.log("\u9078\u55ae - \u672a\u52a0\u5165\u5c0f\u7d44"),localStorage.setItem("GroupID","none"),GroupID="none",a.needGroup=!1)},function(a){console.log("\u53d6\u5f97\u5c0f\u7d44ID\u767c\u751f\u932f\u8aa4\uff1a",a)})}else console.log("\u5c1a\u672a\u767b\u5165"),l.go("login")})}]).controller("root_pblCtrl",["$scope",
"$stateParams","$ionicPopup","$ionicLoading","$state",function(a,q,k,l,m){firebase.auth().onAuthStateChanged(function(g){if("rTO1FDz95FaN59B9FtOqyntQZ4J3"===g.uid){console.log("\u5df2\u767b\u5165\u72c0\u614b");var h=firebase.auth().currentUser,f=[];$("#excel-file").change(function(a){a=a.target.files;var b=new FileReader;b.onload=function(a){try{var b=XLSX.read(a.target.result,{type:"binary"})}catch(r){console.log("\u6a94\u6848\u578b\u5225\u4e0d\u6b63\u78ba");return}for(var c in b.Sheets)b.Sheets.hasOwnProperty(c)&&
(a=b.Sheets[c]["!ref"],console.log(a),f=f.concat(XLSX.utils.sheet_to_json(b.Sheets[c])));console.log(f)};b.readAsBinaryString(a[0])});var c=firebase.firestore();a.addClass=function(){var a=this.className;void 0===a||""===a||0===f.length?(console.log("\u672a\u586b"),k.alert({title:"\u932f\u8aa4",template:"\u8cc7\u6599\u672a\u586b\u5b8c\u6574\u3002"})):k.confirm({title:"\u5275\u7acb\u8ab2\u7a0b",template:"\u78ba\u5b9a\u5275\u7acb\u55ce?"}).then(function(b){if(b){console.log("\u78ba\u5b9a");l.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u5275\u7acb\u8ab2\u7a0b\u4e2d...</p>'});
b=[];for(var e=0;e<f.length;e++)b.push(f[e].\u5b78\u865f);c.collection("\u8ab2\u7a0b").add({ClassName:a,ClassContent:"\u66ab\u7121\u516c\u544a\u3002",inviteLock:!1,maxMembers:6,ClassStu:b}).then(function(a){console.log("\u65b0\u589e\u8ab2\u7a0b\u6210\u529f");var b=c.batch();b.update(c.collection("\u8ab2\u7a0b").doc(a.id),{ClassID:a.id});for(var e={$jscomp$loop$prop$index$2$8:0};e.$jscomp$loop$prop$index$2$8<f.length;e={$jscomp$loop$prop$index$2$8:e.$jscomp$loop$prop$index$2$8},e.$jscomp$loop$prop$index$2$8++)c.collection("\u5e33\u865f").doc(f[e.$jscomp$loop$prop$index$2$8].\u5b78\u865f).get().then(function(d){return function(e){e.exists?
(console.log("\u5df2\u6709\u5e33\u865f"),b.set(c.collection("\u5206\u7d44").doc(a.id).collection("student").doc(f[d.$jscomp$loop$prop$index$2$8].\u5b78\u865f),{grouped:!1}),d.$jscomp$loop$prop$index$2$8===f.length-1&&b.commit().then(function(){console.log("\u66f4\u65b0\u5b78\u751f\u6210\u529f");f=[];l.hide()})["catch"](function(a){console.error("\u66f4\u65b0\u5b78\u751f\u8cc7\u6599\u5931\u6557\uff1a",a)})):(console.log("\u5c1a\u7121\u5e33\u865f"),b.set(c.collection("\u5e33\u865f").doc(f[d.$jscomp$loop$prop$index$2$8].\u5b78\u865f),
{Name:f[d.$jscomp$loop$prop$index$2$8].\u59d3\u540d},{Img:"default"}),b.set(c.collection("\u5206\u7d44").doc(a.id).collection("student").doc(f[d.$jscomp$loop$prop$index$2$8].\u5b78\u865f),{grouped:!1}),firebase.auth().createUserWithEmailAndPassword(f[d.$jscomp$loop$prop$index$2$8].\u5b78\u865f+"@nkust.edu.tw",f[d.$jscomp$loop$prop$index$2$8].\u5b78\u865f).then(function(){console.log("\u8a3b\u518aAuthentication\u6210\u529f");firebase.auth().updateCurrentUser(h)})["catch"](function(a){console.log("\u8a3b\u518aAuthentication\u5931\u6557",
a.message)}),d.$jscomp$loop$prop$index$2$8===f.length-1&&b.commit().then(function(){console.log("\u66f4\u65b0\u5b78\u751f\u6210\u529f");f=[];l.hide()})["catch"](function(a){console.error("\u66f4\u65b0\u5b78\u751f\u8cc7\u6599\u5931\u6557\uff1a",a)}))}}(e))["catch"](function(a){console.log("\u5224\u65b7\u5e33\u865f\u767c\u751f\u932f\u8aa4\uff1a",a)})})["catch"](function(a){console.error("\u65b0\u589e\u8ab2\u7a0b\u5931\u6557\uff1a",a)})}else console.log("\u53d6\u6d88")})};c.collection("\u8ab2\u7a0b").get().then(function(c){a.AllClass=
[];c.forEach(function(b){a.AllClass.push(b.data());m.go(m.current,{},{reload:!0})})});a.LockGroupChange=function(a,b){c.collection("\u8ab2\u7a0b").doc(a).update({inviteLock:b}).then(function(a){console.log("\u66f4\u65b0inviteLock\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0inviteLock\u5931\u6557\uff1a",a)})};a.maxMembersChange=function(a,b){c.collection("\u8ab2\u7a0b").doc(a).update({maxMembers:b}).then(function(a){console.log("\u66f4\u65b0maxMembers\u6210\u529f")})["catch"](function(a){console.error("\u66f4\u65b0maxMembers\u5931\u6557\uff1a",
a)})}}else console.log("\u975e\u7ba1\u7406\u54e1"),m.go("login")})}]).controller("root_groupCtrl",["$scope","$stateParams","$state","$ionicLoading",function(a,q,k,l){var m=firebase.firestore();firebase.auth().onAuthStateChanged(function(g){"rTO1FDz95FaN59B9FtOqyntQZ4J3"===g.uid?(console.log("\u5df2\u767b\u5165\u72c0\u614b"),a.cardShow=!1,m.collection("\u8ab2\u7a0b").get().then(function(h){a.AllClass=[];h.forEach(function(f){a.AllClass.push(f.data());k.go(k.current,{},{reload:!0})})}),a.choose_class=
function(h,f){a.cardShow=!1;l.show({template:'<ion-spinner icon="lines" class="spinner-calm"></ion-spinner><p>\u8f09\u5165\u8cc7\u6599\u4e2d...</p>'});a.Allgroups=[];var c=[];m.collection("\u5206\u7d44").doc(h).collection("student").where("grouped","==",!1).get().then(function(e){e.forEach(function(a){m.collection("\u5e33\u865f").doc(a.id).get().then(function(b){c.push(a.id+b.data().Name)})["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)})});var b=[];m.collection("\u5206\u7d44").doc(h).collection("student").where("grouped",
"==",!0).get().then(function(e){e.forEach(function(a){b.push(a.id)});a.Allgroups=[{ClassName:f,Ngroup:c,Ygroup:b}];e=document.getElementById("container");e=echarts.init(e);option=null;(option={tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:["\u672a\u5206\u7d44","\u5df2\u5206\u7d44"]},series:[{name:"\u5206\u7d44\u72c0\u614b",type:"pie",radius:["50%","70%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"15",
fontWeight:"bold"}}},labelLine:{normal:{show:!1}},data:[{value:c.length,name:"\u672a\u5206\u7d44"},{value:b.length,name:"\u5df2\u5206\u7d44"}]}]},"object"===typeof option)&&e.setOption(option,!0);a.cardShow=!0;l.hide();k.go(k.current,{},{reload:!0})})});a.Allgroups2=[];m.collection("\u5206\u7d44").doc(h).collection("group").get().then(function(c){c.forEach(function(b){for(var c=b.data(),e={$jscomp$loop$prop$index$10:0};e.$jscomp$loop$prop$index$10<b.data().members.length;e={$jscomp$loop$prop$index$10:e.$jscomp$loop$prop$index$10},
e.$jscomp$loop$prop$index$10++)m.collection("\u5e33\u865f").doc(b.data().members[e.$jscomp$loop$prop$index$10]).get().then(function(a){return function(b){c.members[a.$jscomp$loop$prop$index$10]+=b.data().Name}}(e))["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});a.Allgroups2.push(c);k.go(k.current,{},{reload:!0})})})}):(console.log("\u5c1a\u672a\u767b\u5165"),k.go("login"))})}]).controller("root_missionCtrl",["$scope","$stateParams","$state","$ionicPopup",
"$sce",function(a,q,k,l,m){var g=firebase.firestore();firebase.auth().onAuthStateChanged(function(h){"rTO1FDz95FaN59B9FtOqyntQZ4J3"===h.uid?(console.log("\u5df2\u767b\u5165\u72c0\u614b"),a.cardShow=!1,g.collection("\u8ab2\u7a0b").get().then(function(f){a.AllClass=[];f.forEach(function(c){a.AllClass.push(c.data());k.go(k.current,{},{reload:!0})});console.log(a.AllClass)}),a.hide=function(){a.cardShow=!1},a.SelectBtn=function(f){if(void 0!=f){var c=f.ClassID;a.cardShow=!0;a.missions=[];g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(c).collection("\u4efb\u52d9\u5217\u8868").onSnapshot(function(c){c.docChanges().forEach(function(b){if("added"===
b.type){console.log("\u65b0\u589e: ",b.doc.data());var c=0;1==b.doc.data().lock?c=3:-1!=b.doc.data().finished.indexOf("\u6559\u5e2b\u7248")?c=1:b.doc.data().TimeOut.toDate()<new Date&&(c=2);var e=Number(b.doc.data().TimeOut.toDate().getMonth())+1,d=b.doc.data().TimeOut.toDate().getDate();9>=b.doc.data().TimeOut.toDate().getDate()&&(d="0"+b.doc.data().TimeOut.toDate().getDate());a.missions.push({missionID:b.doc.id,Name:b.doc.data().Name,Content:b.doc.data().Content,TimeOut:b.doc.data().TimeOut.toDate().getUTCFullYear()+
"/"+e+"/"+d,LeaderOnly:b.doc.data().LeaderOnly,type:b.doc.data().type,Point:b.doc.data().Point,finished:b.doc.data().finished,HTML:m.trustAsHtml(b.doc.data().HTML),time:b.doc.data().time,lock:c,show:!1,isIRS:b.doc.data().isIRS,showMsg:"\u67e5\u770b\u66f4\u591a"});a.$apply()}else"removed"===b.type&&(console.log("\u522a\u9664: ",b.doc.data()),c=a.missions.findIndex(function(a){return a.time.seconds===b.doc.data().time.seconds&a.time.nanoseconds===b.doc.data().time.nanoseconds}),-1!=c?(a.missions.splice(c,
1),console.log("\u522a\u9664\u4efb\u52d9\u6210\u529f")):console.log("\u522a\u9664\u4efb\u52d9\u4e0d\u6210\u529f"),a.$apply())})});a.AddBtn=function(c){a.AddBtnPopup=[];a.AddBtnPopup.IRS=[];a.AddBtnPopup.LeaderOnly=!1;a.AddBtnPopup.isIRS=!1;a.AddBtnPopup.IRS.testStart=!1;a.AddBtnPopup.HTML="";a.AddBtnPopup.IRS.questions="";var b=c.ClassID;l.show({title:"\u65b0\u589e\u4efb\u52d9",template:'<label class="item item-input item-input"><div class="input-label">\u4efb\u52d9\u540d\u7a31</div><input type="text" ng-model="AddBtnPopup.Name" placeholder="\u8f38\u5165\u4efb\u52d9\u540d\u7a31\uff08\u965015\u5b57\u5167\uff09" maxlength="15"></label><label class="item item-input item-input"><div class="input-label">\u4efb\u52d9\u7c21\u4ecb</div><input type="text" ng-model="AddBtnPopup.Content" placeholder="\u8f38\u5165\u4efb\u52d9\u7c21\u4ecb\uff08\u4e0d\u9650\u5b57\u6578\uff09"></label><label class="item item-input item-input"><div class="input-label">\u5b8c\u6210\u9ede\u6578</div><input type="number" ng-model="AddBtnPopup.Point" placeholder="\u8f38\u5165\u6578\u5b57"></label><label class="item item-input item-select"><div class="input-label">\u4efb\u52d9\u985e\u578b</div><select ng-model="AddBtnPopup.type"><option value="\u96a8\u5802\u6e2c\u9a57">\u96a8\u5802\u6e2c\u9a57</option><option value="\u5c0f\u7d44\u8a0e\u8ad6">\u5c0f\u7d44\u8a0e\u8ad6</option><option value="\u52a0\u5206\u554f\u5377">\u52a0\u5206\u554f\u5377</option><option value="\u8a55\u5206">\u8a55\u5206</option></select></label><label class="item item-input item-select"><div class="input-label">\u622a\u6b62\u65e5\u671f</div><input type="date" ng-model="AddBtnPopup.TimeOut"></label><ion-toggle ng-model="AddBtnPopup.LeaderOnly">\u662f\u5426\u50c5\u9650\u7d44\u9577\u57f7\u884c</ion-toggle><ion-toggle ng-model="AddBtnPopup.isIRS">\u662f\u5426\u9700\u8981\u4f7f\u7528IRS</ion-toggle><label ng-show="!AddBtnPopup.isIRS" class="item item-input item-input"><div class="input-label">HTML</div><textarea cols="50" rows="5" ng-model="AddBtnPopup.HTML" placeholder="\u8f38\u5165HTML\u3002"></textarea></label><div ng-show="AddBtnPopup.isIRS"><label class="item item-input item-input"><div class="input-label">\u8003\u984c\u4e0a\u50b3</div><textarea cols="50" rows="5" ng-model="AddBtnPopup.IRS.questions" placeholder="\u8f38\u5165\u8003\u984c(ex:{})\u3002"></textarea></label><label class="item item-input item-input"><div class="input-label">\u6e2c\u9a57\u6642\u9593</div><input type="number" ng-model="AddBtnPopup.IRS.stageTime" placeholder="\u8f38\u5165\u6578\u5b57(\u55ae\u4f4d\u79d2)"></label><ion-toggle ng-model="AddBtnPopup.IRS.testStart">\u958b\u555f\u6e2c\u9a57</ion-toggle></div>',
scope:a,buttons:[{text:"\u53d6\u6d88",type:"button-default",onTap:function(a){console.log("\u9078\u64c7\u53d6\u6d88")}},{text:"\u65b0\u589e",type:"button-chanry1",onTap:function(c){console.log("\u9078\u64c7\u65b0\u589e");void 0==a.AddBtnPopup.Name||void 0==a.AddBtnPopup.type||void 0==a.AddBtnPopup.TimeOut||void 0==a.AddBtnPopup.LeaderOnly?(console.log("\u8acb\u586b\u5beb\u5b8c\u6574"),l.alert({title:"\u932f\u8aa4",template:"\u8acb\u586b\u5beb\u5b8c\u6574\u3002"})):(a.AddBtnPopup.TimeOut=a.AddBtnPopup.TimeOut.setHours(23,
59,59),a.AddBtnPopup.TimeOut=new Date(a.AddBtnPopup.TimeOut),g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(b).collection("\u4efb\u52d9\u5217\u8868").add({Name:a.AddBtnPopup.Name,Content:a.AddBtnPopup.Content,type:a.AddBtnPopup.type,Point:a.AddBtnPopup.Point,TimeOut:a.AddBtnPopup.TimeOut,LeaderOnly:a.AddBtnPopup.LeaderOnly,isIRS:a.AddBtnPopup.isIRS,HTML:a.AddBtnPopup.HTML,finished:[],lock:!1,time:new Date}).then(function(c){console.log("\u65b0\u589e\u4efb\u52d9\u6210\u529f");a.AddBtnPopup.isIRS&&(a.AddBtnPopup.IRS.questions=
[{indexReal:1,question:"\u672c\u9031\u7ae0\u7bc0\u540d\u7a31\u662f\uff1a",optionA:"\u8cc7\u8a0a\u7ba1\u7406\u7684\u57fa\u672c\u6982\u5ff5\u8207\u67b6\u69cb",optionB:"\u8cc7\u8a0a\u7ba1\u7406\u7684\u79d1\u6280\u89c0\u9ede",optionC:"\u8cc7\u8a0a\u7ba1\u7406\u7684\u61c9\u7528\u7cfb\u7d71\u9762\u89c0\u9ede",optionD:"\u6574\u5408\u6027\u7684\u4f01\u696d\u7cfb\u7d71\u2014ERP\u3001CRM\u8207SCM",answer:1},{indexReal:2,question:"\u300c\u8cc7\u8a0a\u79d1\u6280\u300d\u3001\u300c\u7d93\u6fdf\u74b0\u5883\u300d\u8207\u300c\u7522\u696d\u7d50\u69cb\u300d\u7684\u95dc\u4fc2\u662f\uff1a",
optionA:"\u4e09\u8005\u6709\u4ea4\u4e92\u5f71\u97ff\u95dc\u4fc2",optionB:"\u4e09\u8005\u4e4b\u9593\u6c92\u6709\u95dc\u4fc2",optionC:"\u53ea\u6709\u8cc7\u8a0a\u79d1\u6280\u8207\u7d93\u6fdf\u74b0\u5883\u6709\u95dc\u4fc2",optionD:"\u53ea\u6709\u7d93\u6fdf\u74b0\u5883\u8207\u7522\u696d\u7d50\u69cb\u6709\u95dc\u4fc2",answer:1},{indexReal:3,question:"\u5728\u8cc7\u901a\u8a0a\u79d1\u6280\u6240\u4fc3\u6210\u7684\u65b0\u7d93\u6fdf\u9ad4\u7cfb\u4e2d\uff0c\u5f9e\u300c\u4eba\u5de5\u4f5c\u696d\u300d\u8b8a\u6210\u300c\u96fb\u8166\u4f5c\u696d\u300d\u7684\u5178\u7bc4\u8f49\u79fb\uff0c\u4e00\u822c\u7a31\u70ba\uff1a",
optionA:"\u8cc7\u8a0a\u5316",optionB:"\u667a\u6167\u5316",optionC:"\u865b\u64ec\u5316",optionD:"\u7db2\u8def\u5316",answer:1},{indexReal:4,question:"\u4e0b\u5217\u4f55\u8005\u4e0d\u662f\u8cc7\u8a0a\u79d1\u6280\u6f14\u5316\u76f8\u95dc\u7684\u5b9a\u5f8b\uff1f",optionA:"\u904b\u52d5\u5b9a\u5f8b",optionB:"\u6469\u723e\u5b9a\u5f8b",optionC:"\u5409\u723e\u5fb7\u5b9a\u5f8b",optionD:"\u8c9d\u723e\u5b9a\u5f8b",answer:1},{indexReal:5,question:"\u95dc\u65bcMIS\u7684\u91cd\u8981\u6027\u6558\u8ff0\uff0c\u4f55\u8005\u6b63\u78ba\uff1f",
optionA:"\u6295\u8cc7\u5927",optionB:"\u63d0\u5347\u751f\u7522\u529b",optionC:"\u5275\u9020\u7af6\u722d\u512a\u52e2",optionD:"\u6240\u8ff0\u7686\u662f",answer:4},{indexReal:6,question:"\u7576\u6211\u5011\u63d0\u5230\u786c\u9ad4\u3001\u8edf\u9ad4\u3001\u8cc7\u6599\u5eab\u6216\u7db2\u8def\u6642\uff0c\u6307\u7684\u662fMIS\u77e5\u8b58\u4e2d\u54ea\u4e00\u65b9\u9762\u7684\u8b70\u984c\uff1f",optionA:"IT\u57fa\u790e\u8a2d\u65bd",optionB:"\u4f01\u696d\u7684\u8cc7\u8a0a\u61c9\u7528\u7cfb\u7d71",optionC:"ABIC\u56db\u5927\u79d1\u6280",
optionD:"\u8cc7\u8a0a\u7ba1\u7406",answer:1}],g.collection("IRS").doc(b).collection("\u6e2c\u9a57\u5217\u8868").doc(c.id).set({Name:a.AddBtnPopup.Name,questions:a.AddBtnPopup.IRS.questions,stageTime:1E3*a.AddBtnPopup.IRS.stageTime,testStart:a.AddBtnPopup.IRS.testStart}).then(function(a){console.log("\u65b0\u589eIRS\u6210\u529f")})["catch"](function(a){console.error("\u65b0\u589eIRS\u5931\u6557\uff1a",a)}))})["catch"](function(a){console.error("\u65b0\u589e\u4efb\u52d9\u5931\u6557\uff1a",a)}))}}]})};
a.missionShow=function(c){var b=a.missions.findIndex(function(a){return a.$$hashKey===c.$$hashKey});-1!=b?(a.missions[b].show?(a.missions[b].show=!1,a.missions[b].showMsg="\u67e5\u770b\u66f4\u591a"):(a.missions[b].show=!0,a.missions[b].showMsg="\u6536\u5408\u5167\u5bb9"),console.log("\u4fee\u6539\u986f\u793a\u6210\u529f")):console.log("\u4fee\u6539\u986f\u793a\u4e0d\u6210\u529f")};a.response={};a.responseBtn=function(e){g.collection("\u8ab2\u7a0b\u4efb\u52d9").doc(c).collection("\u4efb\u52d9\u5217\u8868").doc(e).collection("\u586b\u7b54\u7d50\u679c").add({StuID:"\u6559\u5e2b\u7248",
missionID:e,response:a.response,time:new Date}).then(function(a){console.log("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u6210\u529f")})["catch"](function(a){console.error("\u56de\u50b3\u586b\u7b54\u7d50\u679c\u5931\u6557\uff1a",a)})}}else l.alert({title:"\u932f\u8aa4",template:"\u8acb\u9078\u64c7\u8ab2\u7a0b\u3002"})}):(console.log("\u5c1a\u672a\u767b\u5165"),k.go("login"))})}]).controller("rootmenuCtrl",["$scope","$stateParams","$state",function(a,q,k){var l=firebase.firestore();firebase.auth().onAuthStateChanged(function(a){if(a){console.log("\u5df2\u767b\u5165\u72c0\u614b");
var g=a.email.substring(0,a.email.indexOf("@")).toUpperCase();localStorage.getItem("ClassID");l.collection("\u5e33\u865f").doc(g).get().then(function(a){document.getElementById("menu-heading1").innerText=g+" "+a.data().Name;localStorage.setItem("StuName",a.data().Name)})["catch"](function(a){console.log("\u67e5\u8a62\u59d3\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});document.getElementById("menu-list-item8").addEventListener("click",function(){firebase.auth().signOut().then(function(){console.log("\u767b\u51fa\u6210\u529f");
localStorage.clear()})["catch"](function(a){console.log("\u767b\u51fa\u767c\u751f\u932f\u8aa4!")})},!1);l.collection("\u5e33\u865f").doc(g).get().then(function(a){console.log("\u66f4\u65b0\u5927\u982d\u7167\u6210\u529f");firebase.storage().ref().child("members/"+a.data().Img).getDownloadURL().then(function(a){document.getElementById("menu-img").src=a})})["catch"](function(a){console.log("\u67e5\u8a62\u5716\u7247\u6a94\u540d\u767c\u751f\u932f\u8aa4\uff1a",a)});document.getElementById("menu-heading2").innerText=
"Copyright \u00a9 2019 ver "+verson}else console.log("\u5c1a\u672a\u767b\u5165"),k.go("login")})}]);